@page "/books/{Id:guid}"
@inject IBookService BookService
@inject ILoanService LoanService
@inject AuthStateProvider AuthState

<PageTitle>Détail du livre - BookHub</PageTitle>

<a href="/books" class="btn btn-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Retour au catalogue
</a>

@if (book == null)
{
    <p class="text-muted">Chargement du livre...</p>
}
else
{
    <BookCard Book="book" />

    @if (AuthState.IsAdmin)
    {
        <h4 class="mt-4">Historique des emprunts</h4>
        <hr />
        @if (loans != null && loans.Any())
        {
            @foreach (var loan in loans)
            {
                <LoanStatus Loan="loan" />
            }
        }
        else
        {
            <p class="text-muted">Aucun emprunt pour ce livre.</p>
        }
    }

}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private BookDto? book;
    private List<LoanDto>? loans;

    protected override async Task OnInitializedAsync()
    {
        await AuthState.InitializeAsync();

        book = await BookService.GetBookByIdAsync(Id);

        if (AuthState.IsAuthenticated && AuthState.IsAdmin)
        {
            var allLoans = await LoanService.GetOverdueLoansAsync();
            loans = allLoans.Where(l => l.BookId == Id).ToList();
        }
    }
}
